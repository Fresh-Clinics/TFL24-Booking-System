<script>
$(document).ready(function () {
    console.log("Initializing SimplyBook API Data Fetch...");
    let allEventsData = []; // Array to hold all event data for export

    // Initialize JSON-RPC Client for SimplyBook API to fetch the token
    try {
        var loginClient = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me/login',
            'onerror': function (error) {
                console.error("Login Error:", error);
                alert("Error fetching token. Check console for details.");
            }
        });

        // Fetch token dynamically using the SimplyBook API credentials
        loginClient.getToken('thefreshlifeconference', '2b09dc7aee0f1f9d4bdd7f8ae39aa51e1ed13e833d67354b61ef643e8d4947d8', function (token) {
            if (token) {
                console.log("Fetched token: ", token);
                // Fetch events with the token
                fetchEvents(token);
            } else {
                console.error("Failed to fetch token. Please check your API credentials.");
            }
        });
    } catch (e) {
        console.error("Error initializing JSON-RPC client or fetching token:", e);
    }

    // Function to fetch events using the token
    function fetchEvents(token) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        client.request('getEventList', [true, true, null, ''], function (events) {
            if (events) {
                console.log("Fetched events (raw):", events);
                allEventsData = events; // Store events data for export
                // Now fetch start times for the events
                fetchStartTimes(token, events);
            } else {
                console.error("No events returned. Please check the API response.");
            }
        }, function (error) {
            console.error("Error fetching events:", error);
        });
    }

    // Function to fetch Cartesian Start Time Matrix for each event
    function fetchStartTimes(token, events) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        // Update start and end dates as per your request
        var startDate = '2024-10-29';
        var endDate = '2024-10-31';

        let promises = events.map(event => {
            return new Promise((resolve, reject) => {
                var eventId = event.id;
                var providerIds = Object.keys(event.unit_map);

                client.request('getCartesianStartTimeMatrix', [startDate, endDate, eventId, providerIds, 1, null, []], function (timeMatrix) {
                    console.log("Fetched start times for event " + eventId + ":", timeMatrix);
                    
                    // Check and store timeslot data in event
                    if (timeMatrix && timeMatrix.length > 0) {
                        timeMatrix.forEach(matrix => {
                            const timeslots = matrix.timeslots;
                            for (const [date, times] of Object.entries(timeslots)) {
                                if (times.length > 0) {
                                    console.log(`Times for ${date}:`, times);
                                }
                            }
                        });
                    }

                    // Add timeMatrix data to event data for export
                    event.timeMatrix = timeMatrix;
                    resolve(); // Resolve the promise when done
                }, function (error) {
                    console.error("Error fetching start times for event " + eventId + ":", error);
                    reject(error); // Reject the promise on error
                });
            });
        });

        // Wait for all start times to be fetched, showing the export button regardless of success or failure
        Promise.allSettled(promises)
            .then((results) => {
                const failedRequests = results.filter(result => result.status === 'rejected');
                
                if (failedRequests.length > 0) {
                    console.warn(`Some start times couldn't be fetched: ${failedRequests.length} failures.`);
                }

                // Show the export button regardless of success or failure
                $('#exportDataButton').show();
            })
            .catch(error => {
                console.error("Unexpected error in fetching start times:", error);
            });
    }

    // Export data to Excel format
    function exportToExcel(data) {
        // Prepare an array of objects to represent rows in Excel
        let excelData = [];

        // Loop through your data and format it for Excel
        data.forEach(event => {
            // Base row data
            let baseRow = {
                ID: event.id,
                Name: event.name,
                Duration: event.duration,
                Description: event.description,
                IsPublic: event.is_public,
                IsActive: event.is_active,
                Price: event.price,
                Currency: event.currency,
                BookingsLimit: event.bookings_limit,
                // Add other fields as needed
            };

            // If you want to include timeslots, you can process them here
            if (event.timeMatrix && event.timeMatrix.length > 0) {
                event.timeMatrix.forEach(matrix => {
                    for (const [date, times] of Object.entries(matrix.timeslots)) {
                        if (times.length > 0) {
                            times.forEach(time => {
                                // Create a new row for each timeslot
                                let timeslotRow = { ...baseRow };
                                timeslotRow.Date = date;
                                timeslotRow.Time = time;
                                excelData.push(timeslotRow);
                            });
                        }
                    }
                });
            } else {
                // If no timeslots, just push the base row
                excelData.push(baseRow);
            }
        });

        // Convert JSON to worksheet
        let worksheet = XLSX.utils.json_to_sheet(excelData);

        // Create a new workbook and append the worksheet
        let workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'EventsData');

        // Generate Excel file and trigger download
        XLSX.writeFile(workbook, 'events_data.xlsx');
    }

    // Trigger data fetch on button click
    $('#fetchDataButton').click(function () {
        console.log("Fetching data from SimplyBook.me...");
        $(this).prop('disabled', true); // Disable button to prevent duplicate requests
    });

    // Export data on button click
    $('#exportDataButton').click(function () {
        console.log("Exporting data...");
        exportToExcel(allEventsData);
    });
});
</script>
