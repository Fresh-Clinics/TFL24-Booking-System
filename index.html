<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch and Export SimplyBook Data</title>
    <!-- Include jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include the JSONRpcClient library from the local repository -->
    <script src="json-rpc-client.js"></script> <!-- Ensure this path is correct -->
</head>
<body>

<button id="exportButton">Export Fetched Data</button>

<script>
// Object to store fetched data
var fetchedData = {
    events: [],
    startTimeMatrices: {}
};

// Define callback for success and error handling
function handleSuccess(response) {
    console.log('Response received:', response);
    return response;
}

function handleError(error) {
    console.error('Error occurred:', error);
    alert('Error occurred: ' + error.message);
}

// Fetch Token using SimplyBook.me API
var loginClient = new JSONRpcClient({
    'url': 'https://user-api.simplybook.me/login',
    'onerror': handleError
});

try {
    loginClient.getToken('thefreshlifeconference', '897ead6108e21774d62e8cdcd7fd1faf16cf003bc5e93e2f8d502be3afc5f878', function(token) {
        if (!token) {
            console.error('Failed to retrieve token.');
            alert('Failed to retrieve token.');
            return;
        }

        console.log('Token retrieved successfully:', token);

        // Fetch Event List
        var adminClient = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me/admin',
            'headers': {
                'Content-Type': 'application/json',
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': handleError
        });

        // Get the event list - only visible events
        adminClient.getEventList(true, true, null, '', function(events) {
            fetchedData.events = events;
            console.log('Events fetched:', fetchedData.events);

            // Fetch Cartesian Start Time Matrix for specific dates and event IDs
            var startDate = '2024-10-29';
            var endDate = '2024-10-31';

            // Throttle function to avoid API rate limit issues
            function fetchStartTimeMatrixWithThrottle(event, delay) {
                setTimeout(function() {
                    var eventId = event.id;  // Adjust this depending on the response structure
                    adminClient.getCartesianStartTimeMatrix(startDate, endDate, eventId, null, null, null, [], function(startTimeMatrix) {
                        fetchedData.startTimeMatrices[eventId] = startTimeMatrix;
                        console.log('Start Time Matrix for Event ID ' + eventId + ':', startTimeMatrix);
                    }, handleError);
                }, delay);
            }

            // Iterate over each event and fetch Cartesian Start Time Matrix
            var delay = 0;  // Start delay at 0ms
            fetchedData.events.forEach(function(event, index) {
                fetchStartTimeMatrixWithThrottle(event, delay);
                delay += 1000;  // Increment delay by 1000ms (1 second) for each request to prevent hitting rate limits
            });

        }, handleError);

    }, handleError);
} catch (error) {
    handleError(error);
}

// Function to export fetched data as JSON
function exportData() {
    var dataStr = JSON.stringify(fetchedData, null, 2);
    var dataBlob = new Blob([dataStr], { type: 'application/json' });
    var downloadLink = document.createElement('a');
    downloadLink.href = window.URL.createObjectURL(dataBlob);
    downloadLink.download = 'simplybook_data.json';
    downloadLink.click();
}

// Add event listener to the export button
document.getElementById('exportButton').addEventListener('click', exportData);
</script>

</body>
</html>
