<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch SimplyBook.me Data</title>

    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Include JSON-RPC Client Library for SimplyBook.me -->
    <script src="json-rpc-client.js"></script>
</head>
<body>

<button id="fetchDataButton">Fetch Data from SimplyBook.me</button>
<button id="exportDataButton" style="display: none;">Export Data</button>

<script>
$(document).ready(function () {
    console.log("Initializing SimplyBook API Data Fetch...");
    let allEventsData = []; // Array to hold all event data for export

    // Initialize JSON-RPC Client for SimplyBook API to fetch the token
    try {
        var loginClient = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me/login',
            'onerror': function (error) {
                console.error("Login Error:", error);
                alert("Error fetching token. Check console for details.");
            }
        });

        // Fetch token dynamically using the SimplyBook API credentials
        loginClient.getToken('thefreshlifeconference', '897ead6108e21774d62e8cdcd7fd1faf16cf003bc5e93e2f8d502be3afc5f878', function (token) {
            if (token) {
                console.log("Fetched token: ", token);
                // Fetch events with the token
                fetchEvents(token);
            } else {
                console.error("Failed to fetch token. Please check your API credentials.");
            }
        });
    } catch (e) {
        console.error("Error initializing JSON-RPC client or fetching token:", e);
    }

    // Function to fetch events using the token
    function fetchEvents(token) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        client.request('getEventList', [true, true, null, ''], function (events) {
            if (events) {
                console.log("Fetched events (raw):", events);
                allEventsData = events; // Store events data for export
                // Now fetch start times for the events
                fetchStartTimes(token, events);
            } else {
                console.error("No events returned. Please check the API response.");
            }
        }, function (error) {
            console.error("Error fetching events:", error);
        });
    }

    // Function to fetch Cartesian Start Time Matrix for each event
    function fetchStartTimes(token, events) {
        var client = new JSONRpcClient({
            'url': 'https://user-api.simplybook.me',
            'headers': {
                'X-Company-Login': 'thefreshlifeconference',
                'X-Token': token
            },
            'onerror': function (error) {
                console.error("Error in JSON-RPC client setup:", error);
            }
        });

        var startDate = '2024-10-29';
        var endDate = '2024-10-31';

        events.forEach(function(event) {
            var eventId = event.id;
            var providerIds = Object.keys(event.unit_map);

            client.request('getCartesianStartTimeMatrix', [startDate, endDate, eventId, providerIds, 1, null, []], function (timeMatrix) {
                console.log("Fetched start times for event " + eventId + ":", timeMatrix);
                // Add timeMatrix data to event data for export
                event.timeMatrix = timeMatrix; 
            }, function (error) {
                console.error("Error fetching start times for event " + eventId + ":", error);
            });
        });

        // Show export button after fetching events
        $('#exportDataButton').show();
    }

    // Export data to JSON format
    function exportToJSON(data) {
        const json = JSON.stringify(data, null, 2); // Format JSON with 2 spaces indentation
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'events_data.json');
        a.click();
        URL.revokeObjectURL(url); // Cleanup
    }

    // Trigger data fetch on button click
    $('#fetchDataButton').click(function () {
        console.log("Fetching data from SimplyBook.me...");
        $(this).prop('disabled', true); // Disable button to prevent duplicate requests
    });

    // Export data on button click
    $('#exportDataButton').click(function () {
        console.log("Exporting data...");
        exportToJSON(allEventsData);
    });
});
</script>

</body>
</html>
